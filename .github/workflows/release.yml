name: Build and Release

on:
  push:
    tags:
      - 'v*'  # è§¦å‘æ¡ä»¶ï¼šæ¨é€ä»¥ v å¼€å¤´çš„ tagï¼Œå¦‚ v1.0.0

permissions:
  contents: write

jobs:
  # ç”Ÿæˆ Changelog
  changelog:
    name: Generate Changelog
    runs-on: ubuntu-latest
    outputs:
      changelog: ${{ steps.changelog.outputs.changelog }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ä»¥ç”Ÿæˆ changelog

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Generate Changelog
        id: changelog
        uses: metcalfc/changelog-generator@v4.3.1
        with:
          myToken: ${{ secrets.GITHUB_TOKEN }}

  # æ„å»º macOS ç‰ˆæœ¬
  build-macos:
    name: Build macOS
    runs-on: macos-latest
    needs: changelog
    strategy:
      matrix:
        arch: [x64, arm64]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Python (required for DMG building)
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: npm ci

      - name: Generate icons
        run: npm run icons:generate

      - name: Build Next.js
        run: npm run build

      # å¯¼å…¥ Apple å¼€å‘è€…è¯ä¹¦ç”¨äºç­¾åï¼ˆå¦‚æœé…ç½®äº†è¯ä¹¦ï¼‰
      - name: Import Code Signing Certificate
        env:
          APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          # æ£€æŸ¥æ˜¯å¦é…ç½®äº†è¯ä¹¦
          if [ -z "$APPLE_CERTIFICATE_BASE64" ]; then
            echo "âš ï¸ No signing certificate configured, skipping code signing"
            echo "HAS_CERTIFICATE=false" >> $GITHUB_ENV
            exit 0
          fi
          
          echo "HAS_CERTIFICATE=true" >> $GITHUB_ENV
          
          # åˆ›å»ºä¸´æ—¶é’¥åŒ™ä¸²
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
          
          # åˆ›å»ºé’¥åŒ™ä¸²
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          
          # å¯¼å…¥è¯ä¹¦
          echo "$APPLE_CERTIFICATE_BASE64" | base64 --decode > $RUNNER_TEMP/certificate.p12
          security import $RUNNER_TEMP/certificate.p12 -P "$APPLE_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          
          # è®¾ç½®é’¥åŒ™ä¸²æœç´¢åˆ—è¡¨
          security list-keychain -d user -s $KEYCHAIN_PATH
          
          # å…è®¸ codesign è®¿é—®é’¥åŒ™ä¸²ä¸­çš„å¯†é’¥
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          
          # æ¸…ç†è¯ä¹¦æ–‡ä»¶
          rm -f $RUNNER_TEMP/certificate.p12
          
          echo "âœ… Code signing certificate imported successfully"

      - name: Build Electron app (macOS ${{ matrix.arch }})
        run: |
          npx electron-builder --mac --${{ matrix.arch }} --config electron-builder.config.js
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # å¦‚æœæ²¡æœ‰è¯ä¹¦ï¼Œç¦ç”¨è‡ªåŠ¨ç­¾åå‘ç°
          CSC_IDENTITY_AUTO_DISCOVERY: ${{ env.HAS_CERTIFICATE == 'true' }}
          # å…¬è¯ç›¸å…³ç¯å¢ƒå˜é‡ï¼ˆä»…åœ¨é…ç½®äº†è¯ä¹¦æ—¶æœ‰æ•ˆï¼‰
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

      # æ¸…ç†é’¥åŒ™ä¸²
      - name: Cleanup Keychain
        if: always()
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          if [ -f "$KEYCHAIN_PATH" ]; then
            security delete-keychain $KEYCHAIN_PATH 2>/dev/null || true
          fi

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}
          path: |
            dist/*.dmg
            dist/*.zip
          if-no-files-found: error

  # æ„å»º Windows ç‰ˆæœ¬
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    needs: changelog
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate icons
        run: npm run icons:generate

      - name: Build Next.js
        run: npm run build

      - name: Build Electron app (Windows)
        run: |
          npx electron-builder --win --config electron-builder.config.js
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows
          path: |
            dist/*.exe
          if-no-files-found: error

  # æ„å»º Linux ç‰ˆæœ¬
  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    needs: changelog
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate icons
        run: npm run icons:generate

      - name: Build Next.js
        run: npm run build

      - name: Build Electron app (Linux)
        run: |
          npx electron-builder --linux --config electron-builder.config.js
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux
          path: |
            dist/*.AppImage
            dist/*.deb
            dist/*.rpm
          if-no-files-found: error

  # åˆ›å»º Release
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [changelog, build-macos, build-windows, build-linux]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: |
          echo "=== Downloaded artifacts ==="
          find artifacts -type f -name "*" | head -50

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          # macOS
          cp artifacts/macos-x64/*.dmg release-assets/ 2>/dev/null || true
          cp artifacts/macos-x64/*.zip release-assets/ 2>/dev/null || true
          cp artifacts/macos-arm64/*.dmg release-assets/ 2>/dev/null || true
          cp artifacts/macos-arm64/*.zip release-assets/ 2>/dev/null || true
          # Windows
          cp artifacts/windows/*.exe release-assets/ 2>/dev/null || true
          # Linux
          cp artifacts/linux/*.AppImage release-assets/ 2>/dev/null || true
          cp artifacts/linux/*.deb release-assets/ 2>/dev/null || true
          cp artifacts/linux/*.rpm release-assets/ 2>/dev/null || true
          
          echo "=== Release assets ==="
          ls -la release-assets/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: AlgoLocal v${{ needs.changelog.outputs.version }}
          tag_name: ${{ github.ref_name }}
          body: |
            ## ğŸš€ AlgoLocal v${{ needs.changelog.outputs.version }}
            
            Practice coding algorithms 100% offline with AI: generate problems, get hints, discuss solutions, and run code in JavaScript, TypeScript, or Python â€” no internet or setup required.
            
            ### ğŸ“¦ Downloads
            
            | Platform | Architecture | File |
            |----------|--------------|------|
            | **macOS** | Apple Silicon (M1/M2/M3) | `Algorithm-Practice-*-macOS-arm64.dmg` |
            | **macOS** | Intel | `Algorithm-Practice-*-macOS-x64.dmg` |
            | **Windows** | 64-bit Installer | `Algorithm-Practice-*-Windows-Setup.exe` |
            | **Windows** | 64-bit Portable | `Algorithm-Practice-*-Windows-Portable.exe` |
            | **Linux** | AppImage | `Algorithm-Practice-*-Linux.AppImage` |
            | **Linux** | Debian/Ubuntu | `Algorithm-Practice-*-Linux.deb` |
            | **Linux** | Fedora/RHEL | `Algorithm-Practice-*-Linux.rpm` |
            
            ### âš ï¸ macOS Installation Note
            
            If you see **"damaged"** or **"cannot verify developer"** message when opening the app, run this command in Terminal:
            
            ```bash
            # For app installed from DMG
            sudo xattr -rd com.apple.quarantine /Applications/Algorithm\ Practice.app
            
            # Or for app extracted from ZIP (adjust path accordingly)
            sudo xattr -rd com.apple.quarantine ~/Downloads/Algorithm\ Practice.app
            ```
            
            ### ğŸ“ Changelog
            
            ${{ needs.changelog.outputs.changelog }}
            
            ---
            
            ### ä¸­æ–‡è¯´æ˜
            
            100% ç¦»çº¿åˆ·ç®—æ³•ï¼ŒAI å…¨ç¨‹è¾…åŠ©ï¼šç”Ÿæˆé¢˜ç›®ã€è·å–æç¤ºã€è®¨è®ºè§£æ³•ï¼Œæ”¯æŒ JavaScriptã€TypeScriptã€Python ä»£ç è¿è¡Œâ€”â€”æ— éœ€è”ç½‘æˆ–é…ç½®ç¯å¢ƒã€‚
            
            **macOS å®‰è£…æç¤º**ï¼šå¦‚æœæ‰“å¼€åº”ç”¨æ—¶æç¤º"å·²æŸå"æˆ–"æ— æ³•éªŒè¯å¼€å‘è€…"ï¼Œè¯·åœ¨ç»ˆç«¯è¿è¡Œï¼š
            
            ```bash
            sudo xattr -rd com.apple.quarantine /Applications/Algorithm\ Practice.app
            ```
          files: release-assets/*
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          echo "âœ… Release created successfully!"
          echo "ğŸ“¦ Version: v${{ needs.changelog.outputs.version }}"
          echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"

